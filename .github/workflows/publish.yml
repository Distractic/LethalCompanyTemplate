name: Publish

on:
  release:
    types: [ published ]

jobs:
  publish:
    name: Build and publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Necessary to retrieve the latest tag name
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.405

      - name: Restore project dependencies
        run: dotnet restore

      - name: Setup Netcode Patcher
        id: setup-netcode-patcher
        uses: Lordfirespeed/setup-netcode-patcher@v0
        with:
          netcode-patcher-version: 2.4.0
          # https://www.nuget.org/packages/LethalCompany.GameLibs.Steam
          # Must be the same version as the one used in the project
          deps-packages: '[{"id": "UnityEngine.Modules", "version": "2022.3.9"}, {"id": "LethalCompany.GameLibs.Steam", "version": "49.0.0-alpha.1"}]'
          target-framework: "netstandard2.1"

      - name: Install Thunderstore client
        # https://github.com/thunderstore-io/thunderstore-cli
        run: dotnet tool install -g tcli

      - name: Build
        run: dotnet build
        env:
          BUILD_THUNDERSTORE_PACKAGE: true

      - name: Publish
        run: tcli publish --config-path thunderstore.toml --file build/*.zip
        env:
          TCLI_AUTH_TOKEN: ${{ secrets.THUNDERSTORE_AUTH_TOKEN }}

